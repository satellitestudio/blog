<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>React spring</title>
  <link rel="stylesheet" href="../../index.css">
  <link rel="stylesheet" href="../../lib/prism.css">
</head>
<body>
  <a id="logo" href="//satellitestud.io">
    <svg width="150px" viewBox="0 0 183 50" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <desc id="logoDesc">Satellite Studio Logo</desc>
        <path d="M34.767,1.980 C33.655,3.539 33,5.441 33,7.5 C33,12.747 37.253,17 42.5,17 C44.558,17 46.464,16.345 48.020,15.233 C49.294,18.233 50,21.534 50,25 C50,38.807 38.807,50 25,50 C11.192,50 0,38.807 0,25 C0,11.192 11.193,0 25,0 C28.466,0 31.767,0.705 34.767,1.980 Z"></path>
        <path d="M77.488,18.616 C79.44,18.616 81.232,19.576 82.256,21.176 L80.144,23.032 C79.344,22.008 78.352,21.56 77.328,21.56 C76.496,21.56 75.728,22.104 75.728,23.16 C75.728,24.312 76.944,24.824 78.608,25.464 C80.784,26.296 83.12,27.256 83.12,30.136 C83.12,32.92 80.976,35.256 77.52,35.256 C74.192,35.256 72.112,32.952 71.28,30.936 L74.096,29.4 C74.736,30.84 75.856,32.312 77.648,32.312 C78.928,32.312 79.824,31.672 79.824,30.2 C79.824,28.792 77.872,28.408 75.984,27.608 C74.128,26.84 72.528,25.656 72.528,23.192 C72.528,20.696 74.576,18.616 77.488,18.616 Z M85.68,30.36 C85.68,27.032 88.528,25.08 92.656,25.08 L95.44,25.08 L95.44,24.376 C95.44,22.36 94,21.56 92.304,21.56 C90.992,21.56 89.84,22.264 89.296,23.704 L86.256,23.064 C86.928,20.344 89.232,18.616 92.336,18.616 C96.08,18.616 98.768,20.248 98.768,24.984 L98.768,35 L95.952,35 L95.632,32.888 C94.576,34.36 92.912,35.256 90.64,35.256 C87.952,35.256 85.68,33.72 85.68,30.36 Z M89.2,30.36 C89.2,31.448 89.808,32.312 91.216,32.312 C93.264,32.312 95.44,31 95.44,28.216 L95.44,27.864 L92.528,27.864 C90.48,27.864 89.2,28.824 89.2,30.36 Z M101.296,21.816 L101.296,18.872 L103.984,18.872 L103.984,14.424 L107.312,12.344 L107.312,18.872 L111.504,18.872 L111.504,21.816 L107.312,21.816 L107.312,29.688 C107.312,31.512 107.984,32.312 109.456,32.312 C110.032,32.312 110.416,32.216 110.992,31.864 L111.856,34.68 C110.992,35.096 110.16,35.256 109.264,35.256 C106.224,35.256 103.984,33.464 103.984,29.496 L103.984,21.816 L101.296,21.816 Z M121.648,21.56 C119.44,21.56 118.064,23.064 117.712,25.08 L125.552,25.08 C125.264,23.288 124.048,21.56 121.648,21.56 Z M129.072,26.424 L129.072,27.864 L117.648,27.864 C117.648,30.232 119.024,32.312 121.648,32.312 C123.376,32.312 125.04,31.352 125.872,29.592 L128.72,30.712 C127.152,33.752 125.328,35.256 121.648,35.256 C116.336,35.256 114.128,30.776 114.128,26.936 C114.128,23.096 116.336,18.616 121.648,18.616 C126.8,18.616 129.072,22.808 129.072,26.424 Z M132.688,12.344 L136.016,12.344 L136.016,35 L132.688,35 L132.688,12.344 Z M140.368,12.344 L143.696,12.344 L143.696,35 L140.368,35 L140.368,12.344 Z M147.248,14.328 C147.248,13.048 148.24,11.992 149.552,11.992 C150.864,11.992 151.856,13.048 151.856,14.328 C151.856,15.608 150.864,16.6 149.552,16.6 C148.24,16.6 147.248,15.608 147.248,14.328 Z M147.888,18.872 L151.216,18.872 L151.216,35 L147.888,35 L147.888,18.872 Z M154.576,21.816 L154.576,18.872 L157.264,18.872 L157.264,14.424 L160.592,12.344 L160.592,18.872 L164.784,18.872 L164.784,21.816 L160.592,21.816 L160.592,29.688 C160.592,31.512 161.264,32.312 162.736,32.312 C163.312,32.312 163.696,32.216 164.272,31.864 L165.136,34.68 C164.272,35.096 163.44,35.256 162.544,35.256 C159.504,35.256 157.264,33.464 157.264,29.496 L157.264,21.816 L154.576,21.816 Z M174.928,21.56 C172.72,21.56 171.344,23.064 170.992,25.08 L178.832,25.08 C178.544,23.288 177.328,21.56 174.928,21.56 Z M182.352,26.424 L182.352,27.864 L170.928,27.864 C170.928,30.232 172.304,32.312 174.928,32.312 C176.656,32.312 178.32,31.352 179.152,29.592 L182,30.712 C180.432,33.752 178.608,35.256 174.928,35.256 C169.616,35.256 167.408,30.776 167.408,26.936 C167.408,23.096 169.616,18.616 174.928,18.616 C180.08,18.616 182.352,22.808 182.352,26.424 Z"></path>
    </svg>
  </a>

  <article>

    <h1>React, D3 and animation: One Spring to rule all dataviz</h1>

    <cite>
      <strong>
        One Spring to find them,<br>
        One Spring to bring them all<br>
        And in the transitions hook them<br>
      </strong>
    </cite>
    <p>
        When building interactive data visualisation for the web, we should make a decision on a philosophical level:
    </p>
    <ul>
      <li>
          use some kind of charting library, where we will be merely picking a bunch of predefined charts (bar chart, scatterplot, <s>pie chart</s> donut chart, etc) and change colors and fonts. Our likely output, sadly, is yet another boring and pointless dashboard;
      </li>
      <li>
          roll up our sleeves, tap into the raw power of the drawing primitives of the web we know and love: the DOM, SVG, Canvas, WebGL. Build something awesome that is faithful to the designer's vision, to the user expectations and to the underlying meaning of the data.
      </li>
    </ul>
    <figure>
      <img src="cone.png" alt=""/>
      <figcaption>
          This is a conical bivariate scatterplot, which serves as a legend to a map. Every white dot is an entity that produces a certain volume of coffee, with a given "score", representing how socially and environmentally responsible it is. The slices colors match colors on an associated map.
      </figcaption>
    </figure>

    <p>
        That said, if we are to proudly reinvent the wheel, we will need some tools. You should be already familiar with D3, *the* javascript data visualisation library, and probably already read somewhere that D3 is not really, in fact, about data visualisation. It is a low-level collection of tools to draw graphics in the browser, with a heavy focus on SVG (vector graphics). D3 is in fact, the sum of three things:
    </p>

    <ol>
      <li>
        An idiosyncratic way of manipulating <strong>datasets</strong>: the <code>enter/exit/update</code> pattern;
      </li>
      <li>
        <strong>DOM manipulation</strong>: generate HTML tags, attributes, styles, SVG or not, as a function of the above; 
      </li>
      <li>
        Everything that stands in between those two, most importantly <strong>layouts and generators</strong>, which are responsible for turning raw data values to drawing instructions that are useful for rendering. Take for instance <a href="https://github.com/d3/d3-geo">d3-geo</a>, which turns geographical coordinates into drawing instructions for SVG paths.
      </li>
    </ol>


    <hr />

    <p>
      This is great and it works incredibly well for standalone data visualisations, such as notebooks or a data-focused news article, but if you are building an application, chances are you already have something in place for both manipulating data, and manipulating the DOM. In this post we'll talk about React and how to make it play nice with D3; a topic already largely explored (see <a href="https://medium.com/@tibotiber/react-d3-js-balancing-performance-developer-experience-4da35f912484">this recap blogpost</a>, <a href="https://medium.com/@Elijah_Meeks/interactive-applications-with-react-d3-f76f7b3ebc71">Elijah Meeks take</a>'s also good), but we'll add a twist: <strong>animation</strong>.
    </p>


    <figure>
      <img src="react-d3.png" alt="A D3 - React Venn diagram courtesy of Tom McWright. React: Components; React and D3: Dom; D3: Math, scale, layout, utilities, etc">
      <figcaption>
        A D3 - React Venn diagram courtesy of Tom McWright
      </figcaption>
    </figure>

    <h2>Title</h2>

    <p>
      The problem is that both React and D3 want control of the DOM. One method is to leave your graphics DOM manipulation to D3 in a blackbox, let React at the door, and try to hook D3 to your React component lifecycle when data changes. If you already tried integrating a Leaflet map to a React app for example, that would feel quite similar.
    </p>

    <p>
      Doing that, you will end up with two completely opposite programming paradigms: a headache now, and a nightmare 3 months from now. From experience, our take is simple: <strong>do not, ever, let D3 anywhere near the DOM in a React app</strong>.
    </p>

    <hr />

    <p>
      Instead, we'll be taking a leap of faith and write our own DOM in React, from the most humble bar chart to the most convoluted bivariate tilegrid map (yes, <a href="https://xeno.graphics/bivariate-tilegrid-map/">it's a thing</a>).
    </p>
    <p>
      In the case of the former, we can draw things using divs, and bypass D3 entirely, apart from its very useful <a href="https://github.com/d3/d3-scale">scales</a>. For more complex use cases, we will need to know some SVG basics, and use D3 layouts and generators (aka the math that you don't want to write), as explained earlier. This gives you full control of the presentation, while sparing you yet another StackOverflow search for that trigonometry formula.
    </p>

    <p>
      We'll see examples of this with a radial bar chart, a sankey, and a spinning globe. But first, a <strong>bubble diagram</strong>:
    </p>


    <iframe src="https://codesandbox.io/embed/d3-react-bubble-chart-92lfm?fontsize=14" title="d3 React bubble chart" allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media" style="width:100%; height:600px; border:0; border-radius: 4px; overflow:hidden;" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe>

    <p>
      Or more fancily, an <strong>enclosure diagram with circle packing</strong>. This example to show you how we let D3 do the fancy work:
    </p>

    <pre>
      <code class="language-js">
import { pack, hierarchy } from "d3-hierarchy";
import { scaleSequential } from "d3-scale"
import { interpolateYlOrRd, interpolateGreys } from "d3-scale-chromatic"

...

const nodes = hierarchy(data)
  .sum(function(d) { return d.pop; });

const packLayout = pack(data)
  .size([WIDTH, HEIGHT])
  .padding(10)

const root = packLayout(nodes)

const colorScale = scaleSequential([0, 100], interpolateYlOrRd)
const colorScaleRegions = scaleSequential([0, 3000], interpolateGreys)
      </code>
    </pre>

    <ul>
      <li>
        <code>hierarchy</code> generates useful additional data for our dataset: the sum of population for each of the European regions.
      </li>
      <li>
        <code>pack</code> is a d3 <b>layout</b> (<a href="https://github.com/d3/d3-hierarchy#pack">Pack documentation</a>). By far the most interesting bit: it makes a function that takes our dataset made of names and populations, and turns it into actionable values to render: x and y positions, and circle radii. We only have to call it whenever we have a new dataset to render; here the <code>root</code> object is ready to be painted into SVG primitives.
      </li>
      <li>
        Lastly, two color <b>scales</b> (<a href="https://github.com/d3/d3-scale">documentation</a>), aka two functions that will take a population value and return a color along a color scale. Scales can also be for numbers, time, etc.
      </li>
    </ul>

    <p>Generators, layouts and scales are the trinity of D3-in-React. You should not need anything else from D3.</p>

    <hr />

    <p>
      The rest is standard React stuff, but we let's at least look at the SVG part:
    </p>

    <script type="text/plain" class="language-markup">
      <p>Example</p>
   </script>
    <pre>
        <code class="language-markup">
            <script type="prism-html-markup">
                <h1 class="foo">h1. Heading 1</h1>
                <h2>h2. Heading 2</h2>
                <h3>h3. Heading 3</h3>
                <h4>h4. Heading 4</h4>
                <h5>h5. Heading 5</h5>
                <h6>h6. Heading 6</h6>
            </script>
        </code>
    </pre>

    <pre class="language-markup">
        <code class="language-markup">
          <b>lala</b>
          </code>
        </pre>

    <pre class="language-jsx">
      <code><!--
const Bubble = ({leaf}) => {
  // Use x and y coordinates generated by D3 pack layout to position 
  // an SVG group.
  const emojiSize = Math.max(14, leaf.r)
  return <g transform={`translate(${leaf.x},${leaf.y})`}>
    <circle
      r={leaf.r}
      fill={(leaf.data.pop) ? colorScale(leaf.data.pop) : colorScaleRegions(leaf.value)}
    >
      <title>
        {leaf.data.name} - {leaf.data.pop || leaf.value}M
      </title>
    </circle>
    <text
      y={emojiSize/2.3}
      style={{fontSize: `${emojiSize}px`}}
    >
      {leaf.data.emoji}
    </text>
  </g>
}-->
      </code>
    </pre>

    <p>
      This is where a bit of SVG knowledge comes in handy.
    </p>

    <hr />

    <p>
      It's interesting to note that we could have used normal DOM instead of SVG to render the exact same chart. Should we though? While SVG can be a weird beast and has it quirks (text and gradients in particular), it gives us a lot more flexibility and access to complex shapes such as polylines and curves, which we'll make use of later.
    </p>

    <h2>
      Animation
    </h2>



    <p>
        Tom McWright made a great description of this D3-React approach a while ago. The conclusion though, left us a bit frustrated:
    </p>

    <cite>
        The elephant in the room, for some, is animation. d3 is very concerned with making animation possible and its selection API reflects that fact. Personally I avoid animation whenever possible, and so I haven't invested much time getting it to work with this approach (…).
    </cite>

    <p>
        We did invest some time. Because animation, when done right (and with frugality), is a crucial part of interactive information design. Animation helps understanding the dynamic nature of a dataset. How values evolve over time, naturally, but also how they change when switching context (which also goes for UI transitions). If anything, <a href="https://www.youtube.com/watch?v=jbkSRLYSojo">the late Hans Rosling should convince you INVOKE HIM</a>.
    </p>

    <figure>
      <img src="hans-rosling.gif" alt="Hans Rosling explaining a chart with his whole body">
    </figure>

    <p>
        Transitions is a technical problem we want to tackle early on, because moving around a high number of things on a screen ties in with performance optimization and code structure.This   will have an impact on fundamental technical choices we make.
    </p>

    <p>
        The thing is, transitions in D3 are done perfectly right. In most scenarios performance is good (sans WebGL), and to say they don't get in the way is an understatement. As in, basically, just add this line of code:
    </p>

    <pre><code class="language-js">
.transition()
    </code></pre>

    <p>
        But it goes hand in hand with D3's selection mechanism, which makes it a no go. The state of animation in React, on the other hand, is frankly a bit depressing, to the point where a lot of advice you can hear is: "just use CSS transitions".
    </p>

    <figure>
      <img class="small" src="no.gif" alt="Michael Schott says no">
    </figure>

    <p>
        The declarative nature of React does indeed make a nice developer experience for transitions complicated. Some of us, a long long long time ago, were doing Flash websites and got used to simple and fully programmable animation APIs, and want the same experience in React. One of us, namely Cheng Lou, 
    </p>
  
    <p>
      While it's certainly not new, I recently came across Cheng Lou's talk "The state of animation in React". I'm a gigantic fan of this talk, not the least because he talks about Flash with an absolutely brilliant brazenness. Yes, Flash was awesome. It's not today's topic, but let's leave it at this: Flash got animation right and we modern web developers ought to take inspiration.
    </p>

    <p>
      Where Cheng's react-motion cleared a path, a jewel of a library named react-spring picked up.
    </p>


    <iframe src="https://codesandbox.io/embed/radial-bar-chart-react-d3-spring-hooks-2lul1?fontsize=14" title="radial bar chart react + d3 + spring + hooks" allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe>



    <iframe src="https://codesandbox.io/embed/sankey-react-d3-spring-hooks-c7vef?fontsize=14" title="sankey react + d3 + spring + hooks" allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe>

    <iframe src="https://codesandbox.io/embed/miniglobe-with-d3-react-spring-rz7nl?fontsize=14" title="Miniglobe with D3 + React + Spring" allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media" style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe>


 

  

  </article>
  <script src="../../lib/prism.js"></script>
  <script src="../../index.js"></script>
</body>
</html>